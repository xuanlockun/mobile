<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quản lý Nhân viên</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f5f5f5;
    }

    /* Navbar Styles */
    nav {
      background-color: #4CAF50;
      color: white;
      padding: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    nav ul {
      list-style-type: none;
      margin: 0;
      padding: 0;
      display: flex;
    }

    nav ul li {
      margin: 0 15px;
    }

    nav ul li a {
      color: white;
      text-decoration: none;
      font-weight: bold;
      padding: 5px 10px;
    }

    nav ul li a:hover {
      background-color: #45a049;
      border-radius: 5px;
    }

    .logout-btn {
      background-color: #f44336;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 20px;
    }

    .logout-btn:hover {
      background-color: #d32f2f;
    }

    /* Main container */
    .container {
      max-width: 800px;
      margin: 20px auto;
      padding: 20px;
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }

    .form-group input {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
    }

    select {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      background-color: #f9f9f9;
      font-size: 16px;
    }

    button {
      padding: 10px 20px;
      border: none;
      background-color: #4CAF50;
      color: white;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
    }

    button:hover {
      background-color: #45a049;
    }

    .employee-list table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    .employee-list th, .employee-list td {
      border: 1px solid #ddd;
      padding: 12px;
      text-align: left;
    }

    .employee-list th {
      background-color: #f2f2f2;
      font-weight: bold;
    }

    .checkbox-group {
      display: flex;
      align-items: center;
      margin: 15px 0;
    }

    .checkbox-group input {
      margin-right: 10px;
    }

    .error-message {
      color: #f44336;
      margin-top: 10px;
    }

    .success-message {
      color: #4CAF50;
      margin-top: 10px;
    }

    .hidden {
      display: none;
    }
  </style>
</head>
<body>

  <!-- Navbar -->
  <nav>
    <ul>
      <li><a href="#" id="homeLink">Trang chủ</a></li>
      <li><a href="#" id="manageLink">Quản lý nhân viên</a></li>
    </ul>
    <button class="logout-btn" id="logoutBtn">Đăng xuất</button>
  </nav>

  <!-- Main Content -->
  <div class="container" id="contentArea">
    <!-- Content will be loaded here dynamically -->
  </div>

  <!-- Login Template -->
  <template id="loginTemplate">
    <div class="login-container">
      <h1>Đăng nhập hệ thống</h1>
      <form id="loginForm">
        <div class="form-group">
          <label for="loginPhone">Số điện thoại:</label>
          <input type="text" id="loginPhone" name="phone_number" required>
        </div>
        <div class="form-group">
          <label for="loginPassword">Mật khẩu:</label>
          <input type="password" id="loginPassword" name="password" required>
        </div>
        <button type="submit">Đăng nhập</button>
        <div id="loginError" class="error-message"></div>
      </form>
    </div>
  </template>

  <!-- Management Template -->
  <template id="manageTemplate">
    <h1>Quản lý Nhân viên</h1>

    <!-- Employee Registration Form -->
    <h2>Đăng ký nhân viên mới</h2>
    <form id="registerForm">
      <div class="form-group">
        <label for="full_name">Họ và Tên:</label>
        <input type="text" id="full_name" name="full_name" required>
      </div>
      <div class="form-group">
        <label for="phone_number">Số điện thoại:</label>
        <input type="text" id="phone_number" name="phone_number" required>
      </div>
      <div class="form-group">
        <label for="age">Tuổi:</label>
        <input type="number" id="age" name="age" required>
      </div>
      <div class="form-group">
        <label for="position">Chức vụ:</label>
        <select id="position" name="position" required>
          <option value="">Chọn chức vụ</option>
          <option value="Quản lý">Quản lý</option>
          <option value="Phục vụ">Phục vụ</option>
          <option value="Đầu bếp">Đầu bếp</option>
          <option value="Nhân viên kho">Nhân viên kho</option>
        </select>
      </div>
      
      <div class="form-group">
        <label for="password">Mật khẩu:</label>
        <input type="password" id="password" name="password" required>
      </div>

      <div class="checkbox-group">
        <input type="checkbox" id="defaultPassword">
        <label for="defaultPassword">Sử dụng mật khẩu mặc định "Nhanvienuit123"</label>
      </div>

      <button type="submit">Đăng ký nhân viên</button>
      <div id="registerMessage" class="error-message"></div>
    </form>

    <!-- Employee List -->
    <div class="employee-list">
      <h2>Danh sách nhân viên</h2>
      <table id="employeeTable">
        <thead>
          <tr>
            <th>Họ và Tên</th>
            <th>Số điện thoại</th>
            <th>Tuổi</th>
            <th>Chức vụ</th>
          </tr>
        </thead>
        <tbody>
          <!-- Employee data will be inserted here -->
        </tbody>
      </table>
    </div>
  </template>

  <script>
    // Global variables
    let currentUser = null;
    const API_BASE_URL = 'http://160.191.175.184:3000';
    const contentArea = document.getElementById('contentArea');
    const loginTemplate = document.getElementById('loginTemplate');
    const manageTemplate = document.getElementById('manageTemplate');
    const logoutBtn = document.getElementById('logoutBtn');
    const homeLink = document.getElementById('homeLink');
    const manageLink = document.getElementById('manageLink');

    // Initialize the application
    document.addEventListener('DOMContentLoaded', () => {
      checkAuthentication();
      setupEventListeners();
    });

    // Check if user is authenticated
    function checkAuthentication() {
      const token = localStorage.getItem('token');
      
      if (!token) {
        showLoginPage();
        return;
      }

      verifyToken(token);
    }

    // Verify token with server
    function verifyToken(token) {
      fetch(`${API_BASE_URL}/profile`, {
        headers: {
          'Authorization': `Bearer ${token}`
        }
      })
      .then(response => {
        if (response.ok) {
          return response.json();
        }
        throw new Error('Token verification failed');
      })
      .then(data => {
        currentUser = data.profile;
        if (currentUser.position.toLowerCase() === 'quản lý') {
          showManagementPage();
        } else {
          // If not manager, show login with message
          showLoginPage('Chỉ quản lý mới có quyền truy cập');
          localStorage.removeItem('token');
        }
      })
      .catch(error => {
        console.error('Token verification error:', error);
        localStorage.removeItem('token');
        showLoginPage();
      });
    }

    // Show login page
    function showLoginPage(message = '') {
      const loginClone = loginTemplate.content.cloneNode(true);
      contentArea.innerHTML = '';
      contentArea.appendChild(loginClone);
      
      if (message) {
        document.getElementById('loginError').textContent = message;
      }

      // Setup login form
      document.getElementById('loginForm').addEventListener('submit', handleLogin);
    }

    // Show management page
    function showManagementPage() {
      const manageClone = manageTemplate.content.cloneNode(true);
      contentArea.innerHTML = '';
      contentArea.appendChild(manageClone);
      
      // Setup form and load employees
      setupManagementPage();
      fetchEmployeeList();
    }

    // Handle login form submission
    function handleLogin(event) {
      event.preventDefault();
      const phone = document.getElementById('loginPhone').value;
      const password = document.getElementById('loginPassword').value;
      const errorElement = document.getElementById('loginError');

      fetch(`${API_BASE_URL}/login`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          phone_number: phone,
          password: password
        })
      })
      .then(response => {
        if (!response.ok) {
          return response.json().then(err => { throw err; });
        }
        return response.json();
      })
      .then(data => {
        localStorage.setItem('token', data.access_token);
        checkAuthentication(); // Verify the token and load appropriate page
      })
      .catch(error => {
        errorElement.textContent = error.error || 'Đăng nhập thất bại';
      });
    }

    // Setup management page elements
    function setupManagementPage() {
      // Default password checkbox
      const defaultPasswordCheckbox = document.getElementById('defaultPassword');
      const passwordField = document.getElementById('password');

      defaultPasswordCheckbox.addEventListener('change', function() {
        if (this.checked) {
          passwordField.disabled = true;
          passwordField.value = 'Nhanvienuit123';
        } else {
          passwordField.disabled = false;
          passwordField.value = '';
        }
      });

      // Registration form
      document.getElementById('registerForm').addEventListener('submit', handleEmployeeRegistration);
    }

    // Handle employee registration
    function handleEmployeeRegistration(event) {
      event.preventDefault();
      const form = event.target;
      const messageElement = document.getElementById('registerMessage');

      const formData = {
        full_name: form.full_name.value,
        phone_number: form.phone_number.value,
        age: form.age.value,
        position: form.position.value,
        password: form.password.value
      };

      fetch(`${API_BASE_URL}/register`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${localStorage.getItem('token')}`
        },
        body: JSON.stringify(formData)
      })
      .then(response => {
        if (!response.ok) {
          return response.json().then(err => { throw err; });
        }
        return response.json();
      })
      .then(data => {
        messageElement.textContent = 'Đăng ký nhân viên thành công';
        messageElement.className = 'success-message';
        form.reset();
        fetchEmployeeList();
      })
      .catch(error => {
        messageElement.textContent = error.error || 'Đăng ký thất bại';
        messageElement.className = 'error-message';
      });
    }

    // Fetch employee list
    function fetchEmployeeList() {
      fetch(`${API_BASE_URL}/employees`, {
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('token')}`
        }
      })
      .then(response => {
        if (!response.ok) {
          throw new Error('Failed to fetch employees');
        }
        return response.json();
      })
      .then(data => {
        const tableBody = document.querySelector('#employeeTable tbody');
        tableBody.innerHTML = '';

        data.forEach(employee => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${employee.full_name}</td>
            <td>${employee.phone_number}</td>
            <td>${employee.age}</td>
            <td>${employee.position}</td>
          `;
          tableBody.appendChild(row);
        });
      })
      .catch(error => {
        console.error('Error fetching employees:', error);
      });
    }

    // Setup event listeners
    function setupEventListeners() {
      // Logout button
      logoutBtn.addEventListener('click', () => {
        localStorage.removeItem('token');
        showLoginPage();
      });

      // Navigation links
      homeLink.addEventListener('click', (e) => {
        e.preventDefault();
        if (currentUser) {
          showManagementPage();
        }
      });

      manageLink.addEventListener('click', (e) => {
        e.preventDefault();
        if (currentUser) {
          showManagementPage();
        }
      });
    }
  </script>
</body>
</html>